# æ•°æ®é¢„å¤„ç†è°ƒè¯•è„šæœ¬ä½¿ç”¨æŒ‡å—

## è„šæœ¬åŠŸèƒ½

`debug_preprocess.sh` æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºè°ƒè¯•æ•°æ®é¢„å¤„ç†é—®é¢˜çš„è„šæœ¬ï¼Œå®ƒä¼šï¼š

1. âœ… **æ•°æ®æ£€æŸ¥**ï¼šåœ¨å¤„ç†å‰æ£€æŸ¥åŸå§‹æ•°æ®çš„å®Œæ•´æ€§
2. ğŸ” **å¯¹æ¯”å¤„ç†**ï¼šåˆ†åˆ«å¤„ç†æˆåŠŸæ¡ˆä¾‹(0001)å’Œå¤±è´¥æ¡ˆä¾‹(0008)
3. ğŸ“Š **è¯¦ç»†æ—¥å¿—**ï¼šç”Ÿæˆè¯¦ç»†çš„å¤„ç†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
4. ğŸ“ **è‡ªåŠ¨åˆ†æ**ï¼šè‡ªåŠ¨æå–å’Œåˆ†æé”™è¯¯ä¿¡æ¯
5. ğŸ§¹ **é¿å…è·³è¿‡**ï¼šè‡ªåŠ¨æ¸…ç†æ—§è¾“å‡ºï¼Œé¿å…"è·³è¿‡å·²å¤„ç†"

## å¿«é€Ÿä½¿ç”¨

### åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /yangjunjie/Med-3D-LLM-main

# 2. ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
chmod +x scripts/debug_preprocess.sh

# 3. è¿è¡Œè°ƒè¯•è„šæœ¬
bash scripts/debug_preprocess.sh
```

### è¿è¡Œè¿‡ç¨‹

è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

```
1. æ£€æŸ¥æ•°æ®é›†åŸºæœ¬ä¿¡æ¯
   â”œâ”€ 0001 æ•°æ®é›†ç»“æ„
   â””â”€ 0008 æ•°æ®é›†ç»“æ„

2. å¤„ç†æˆåŠŸæ•°æ®é›† (0001)
   â”œâ”€ æ¸…ç†æ—§è¾“å‡º
   â”œâ”€ æ‰§è¡Œé¢„å¤„ç†
   â”œâ”€ ä¿å­˜æ—¥å¿—åˆ° debug_logs/0001_preprocess.log
   â””â”€ æ£€æŸ¥è¾“å‡ºç»“æœ

3. å¤„ç†å¤±è´¥æ•°æ®é›† (0008)
   â”œâ”€ æ¸…ç†æ—§è¾“å‡º
   â”œâ”€ æ‰§è¡Œé¢„å¤„ç†
   â”œâ”€ ä¿å­˜æ—¥å¿—åˆ° debug_logs/0008_preprocess.log
   â””â”€ æ£€æŸ¥è¾“å‡ºç»“æœ

4. ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
   â”œâ”€ å¯¹æ¯”ä¸¤ä¸ªæ•°æ®é›†çš„å¤„ç†ç»“æœ
   â”œâ”€ æå–0008çš„é”™è¯¯ä¿¡æ¯
   â””â”€ ä¿å­˜æ‘˜è¦åˆ° debug_logs/comparison_summary.txt
```

## è¾“å‡ºæ–‡ä»¶

è¿è¡Œåä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

```
debug_logs/
â”œâ”€â”€ 0001_preprocess.log          # æˆåŠŸæ¡ˆä¾‹çš„å®Œæ•´æ—¥å¿—
â”œâ”€â”€ 0008_preprocess.log          # å¤±è´¥æ¡ˆä¾‹çš„å®Œæ•´æ—¥å¿—
â””â”€â”€ comparison_summary.txt       # å¯¹æ¯”æ‘˜è¦æŠ¥å‘Š

debug_processed/
â”œâ”€â”€ 0001/                        # æˆåŠŸæ¡ˆä¾‹çš„å¤„ç†è¾“å‡º
â”‚   â”œâ”€â”€ metadata.csv
â”‚   â””â”€â”€ processed/
â”‚       â””â”€â”€ PANCREAS_XXXX/
â”‚           â””â”€â”€ masks/
â””â”€â”€ 0008/                        # å¤±è´¥æ¡ˆä¾‹çš„å¤„ç†è¾“å‡º
    â”œâ”€â”€ metadata.csv
    â””â”€â”€ processed/
        â””â”€â”€ PANCREAS_XXXX/
            â””â”€â”€ masks/
```

## æŸ¥çœ‹ç»“æœ

### 1. æŸ¥çœ‹å¯¹æ¯”æ‘˜è¦

```bash
cat debug_logs/comparison_summary.txt
```

### 2. æŸ¥çœ‹å¤±è´¥æ¡ˆä¾‹çš„å®Œæ•´æ—¥å¿—

```bash
cat debug_logs/0008_preprocess.log
```

### 3. æŸ¥çœ‹å¤±è´¥æ¡ˆä¾‹çš„é”™è¯¯ä¿¡æ¯

```bash
grep -i -A 10 "error\|exception" debug_logs/0008_preprocess.log
```

### 4. å¯¹æ¯”ä¸¤ä¸ªæ•°æ®é›†çš„æ—¥å¿—å·®å¼‚

```bash
diff debug_logs/0001_preprocess.log debug_logs/0008_preprocess.log
```

### 5. æ£€æŸ¥è¾“å‡ºæ–‡ä»¶ç»“æ„

```bash
# æˆåŠŸæ¡ˆä¾‹çš„è¾“å‡º
tree debug_processed/0001/ -L 3

# å¤±è´¥æ¡ˆä¾‹çš„è¾“å‡º
tree debug_processed/0008/ -L 3
```

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæ‰¾ä¸åˆ°æ•°æ®é›†

**é”™è¯¯ä¿¡æ¯**ï¼š
```
âŒ é”™è¯¯: ç›®å½•ä¸å­˜åœ¨
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ£€æŸ¥æ•°æ®é›†è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼š
```bash
ls -la M3D_Seg/0001/0001/
ls -la M3D_Seg/0008/0008/
```

### é—®é¢˜2ï¼šmasksç›®å½•ä¸ºç©º

**ç—‡çŠ¶**ï¼š
```
masks/ æ–‡ä»¶æ•°: 0
```

**å¯èƒ½åŸå› **ï¼š
- åˆ†å‰²æ©ç æ–‡ä»¶ç¼ºå¤±æˆ–æŸå
- å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™ä½†æœªæŠ¥å‘Š
- å†…å­˜ä¸è¶³å¯¼è‡´å¤„ç†ä¸­æ–­

**æ’æŸ¥æ–¹æ³•**ï¼š
1. æŸ¥çœ‹å®Œæ•´æ—¥å¿—ï¼š`cat debug_logs/0008_preprocess.log`
2. æ£€æŸ¥åŸå§‹maskæ–‡ä»¶ï¼š`ls -lh M3D_Seg/0008/0008/PANCREAS_*/mask_*.npz`

### é—®é¢˜3ï¼šPythonå¼‚å¸¸

**æ’æŸ¥æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹å®Œæ•´çš„Python traceback
grep -B 5 -A 20 "Traceback" debug_logs/0008_preprocess.log
```

### é—®é¢˜4ï¼šå†…å­˜ä¸è¶³

**ç—‡çŠ¶**ï¼š
- è¿›ç¨‹è¢«killed
- æ—¥å¿—çªç„¶ä¸­æ–­

**è§£å†³æ–¹æ¡ˆ**ï¼š
è„šæœ¬å·²ä½¿ç”¨ `NUM_WORKERS=1` æ¥é™ä½å†…å­˜ä½¿ç”¨ã€‚å¦‚æœä»ç„¶ä¸è¶³ï¼Œå¯ä»¥ï¼š
1. å‡å°‘å…¶ä»–è¿è¡Œä¸­çš„è¿›ç¨‹
2. ä½¿ç”¨æ›´å°çš„æ•°æ®é›†æµ‹è¯•
3. å¢åŠ swapç©ºé—´

## è‡ªå®šä¹‰é…ç½®

å¦‚éœ€ä¿®æ”¹é…ç½®ï¼Œç¼–è¾‘è„šæœ¬å¼€å¤´çš„å‚æ•°ï¼š

```bash
# é…ç½®å‚æ•°
ROOT_DIR="./M3D_Seg"              # æ•°æ®æ ¹ç›®å½•
OUTPUT_DIR="./debug_processed"    # è¾“å‡ºç›®å½•
NUM_WORKERS=1                     # å¹¶è¡Œè¿›ç¨‹æ•°ï¼ˆ1=å•è¿›ç¨‹è°ƒè¯•æ¨¡å¼ï¼‰
LOG_DIR="./debug_logs"            # æ—¥å¿—ç›®å½•
```

## è°ƒè¯•æŠ€å·§

### 1. é€æ­¥è°ƒè¯•

å¦‚æœæƒ³å•ç‹¬å¤„ç†æŸä¸ªæ•°æ®é›†ï¼š

```bash
# åªå¤„ç†0008
python -u dataset_toolkits/process_m3d_seg_format.py \
    --data_root ./M3D_Seg/0008/0008 \
    --output_dir ./debug_processed/0008_single \
    --num_workers 1 \
    --use_mask \
    --compute_sdf \
    --replace_npy \
    --no_skip 2>&1 | tee debug_0008_manual.log
```

### 2. æ£€æŸ¥æ•°æ®æ–‡ä»¶

```bash
# ä½¿ç”¨Pythonæ£€æŸ¥NPYæ–‡ä»¶
python << EOF
import numpy as np
import sys

# æ£€æŸ¥image.npy
try:
    img = np.load('M3D_Seg/0008/0008/PANCREAS_0001/image.npy')
    print(f"Image shape: {img.shape}")
    print(f"Image dtype: {img.dtype}")
    print(f"Image range: [{img.min()}, {img.max()}]")
except Exception as e:
    print(f"Error loading image: {e}")

# æ£€æŸ¥maskæ–‡ä»¶
try:
    from scipy import sparse
    mask_file = 'M3D_Seg/0008/0008/PANCREAS_0001/mask_*.npz'
    import glob
    masks = glob.glob(mask_file.replace('*', '*'))
    if masks:
        seg = sparse.load_npz(masks[0])
        print(f"Mask shape: {seg.shape}")
        print(f"Mask nnz: {seg.nnz}")
    else:
        print("No mask files found")
except Exception as e:
    print(f"Error loading mask: {e}")
EOF
```

### 3. å¯ç”¨æ›´è¯¦ç»†çš„è°ƒè¯•

ä¿®æ”¹è„šæœ¬ä¸­çš„Pythonè°ƒç”¨ï¼Œæ·»åŠ è°ƒè¯•ç¯å¢ƒå˜é‡ï¼š

```bash
PYTHONVERBOSE=1 python -u dataset_toolkits/process_m3d_seg_format.py ...
```

## é¢„æœŸè¾“å‡ºç¤ºä¾‹

### æˆåŠŸæƒ…å†µ

```
å¤„ç†æ•°æ®é›†: 0001
========================================
âœ“ æˆåŠŸ
è€—æ—¶: 45ç§’
å¤„ç†çš„ç—…ä¾‹æ•°: 10
æ ·æœ¬ç—…ä¾‹: PANCREAS_0001
  masks/ æ–‡ä»¶æ•°: 3
    1_sdf.npz
    organ_labels.json
    segmentation_masks.npz
```

### å¤±è´¥æƒ…å†µ

```
å¤„ç†æ•°æ®é›†: 0008
========================================
âŒ å¤±è´¥
é€€å‡ºç : 1
è€—æ—¶: 12ç§’

é”™è¯¯æ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰:
  Traceback (most recent call last):
    ...
  ValueError: Invalid mask shape
```

## æŠ€æœ¯æ”¯æŒ

å¦‚æœè°ƒè¯•è„šæœ¬æœ¬èº«æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. Pythonç¯å¢ƒæ˜¯å¦æ­£ç¡®æ¿€æ´»
2. æ‰€éœ€ä¾èµ–æ˜¯å¦å·²å®‰è£…ï¼ˆnumpy, scipy, tqdmç­‰ï¼‰
3. CUDAæ˜¯å¦å¯ç”¨ï¼ˆç”¨äºSDFè®¡ç®—ï¼‰
4. ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³

## æ¸…ç†è°ƒè¯•æ–‡ä»¶

è°ƒè¯•å®Œæˆåï¼Œå¯ä»¥æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼š

```bash
# åˆ é™¤è°ƒè¯•è¾“å‡º
rm -rf debug_processed/

# ä¿ç•™æ—¥å¿—æ–‡ä»¶ä¾›åç»­å‚è€ƒ
# å¦‚éœ€åˆ é™¤ï¼šrm -rf debug_logs/
```

---

**åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-31  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šMed-3D-LLM æ•°æ®é¢„å¤„ç†æ¨¡å—

