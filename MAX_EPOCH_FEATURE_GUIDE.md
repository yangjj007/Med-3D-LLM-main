# max_epoch åŠŸèƒ½è¯´æ˜æ–‡æ¡£

## æ¦‚è¿°

å·²æˆåŠŸåœ¨è®­ç»ƒæµç¨‹ä¸­æ·»åŠ  `max_epoch` å‚æ•°æ”¯æŒï¼Œè®­ç»ƒå°†åœ¨è¾¾åˆ° `max_epoch` æˆ– `max_steps` æ—¶åœæ­¢ï¼ˆä»¥å…ˆåˆ°ä¸ºå‡†ï¼‰ã€‚åŒæ—¶æ”¹è¿›äº†è®­ç»ƒä¿¡æ¯è¾“å‡ºï¼Œæ˜¾ç¤ºæ•°æ®æ ·æœ¬æ•°å’Œ epoch ç›¸å…³ä¿¡æ¯ã€‚

## ä¿®æ”¹å†…å®¹

### 1. è®­ç»ƒå™¨åŸºç±»ä¿®æ”¹ (`trellis/trainers/base.py`)

#### æ·»åŠ çš„åŠŸèƒ½ï¼š

- **æ–°å‚æ•° `max_epoch`**: åœ¨ `__init__` æ–¹æ³•ä¸­æ·»åŠ äº†å¯é€‰çš„ `max_epoch` å‚æ•°
- **è‡ªåŠ¨è®¡ç®—**:
  - `self.dataset_size`: æ•°æ®é›†å¤§å°
  - `self.steps_per_epoch`: æ¯ä¸ª epoch çš„æ­¥æ•°
  - `self.epoch`: å½“å‰ epoch æ•°
  
- **åœæ­¢æ¡ä»¶**: 
  - å¦‚æœæŒ‡å®šäº† `max_epoch`ï¼Œä¼šè®¡ç®—å¯¹åº”çš„æœ€å¤§æ­¥æ•°
  - å®é™…ä½¿ç”¨ `min(max_steps, max_steps_from_epoch)` ä½œä¸ºè®­ç»ƒç»ˆæ­¢æ¡ä»¶
  - å¦‚æœ `max_epoch` å’Œ `max_steps` éƒ½æœªæŒ‡å®šï¼Œä¼šæŠ›å‡ºé”™è¯¯

#### æ”¹è¿›çš„è®­ç»ƒä¿¡æ¯è¾“å‡ºï¼š

**è®­ç»ƒå¼€å§‹æ—¶æ˜¾ç¤º**:
```
ğŸ“Š è®­ç»ƒå¾ªç¯å¼€å§‹
====================================================================================================

ğŸ“¦ æ•°æ®é›†ä¿¡æ¯:
  æ•°æ®é›†å¤§å°: 150 æ ·æœ¬
  æ‰¹å¤§å°: 4 (æ¯GPU: 2, ä¸–ç•Œå¤§å°: 2)
  æ¯ä¸ª Epoch æ­¥æ•°: 38 steps

ğŸ¯ è®­ç»ƒç›®æ ‡:
  æœ€å¤§æ­¥æ•°: 100,000 steps
  æœ€å¤§ Epoch: null (æˆ–å…·ä½“æ•°å€¼)
  å°†è®­ç»ƒçº¦ 2631.58 ä¸ª epoch
  æ€»è®¡å°†å¤„ç†çº¦ 400,000 ä¸ªæ ·æœ¬æ¬¡æ•°

ğŸ”„ è®­ç»ƒçŠ¶æ€:
  èµ·å§‹æ­¥æ•°: 0
  èµ·å§‹ Epoch: 0
  å‰©ä½™æ­¥æ•°: 100,000
====================================================================================================
```

**æ¯ä¸ª step çš„è¾“å‡º**:
```
[Epoch 0 | Step      1/100000 (1/38)] Loss: 0.123456 | æ—¶é—´: 1.234s (æ•°æ®: 0.123s, è®­ç»ƒ: 1.111s)
```
- æ˜¾ç¤ºå½“å‰ Epoch
- æ˜¾ç¤º step è¿›åº¦
- æ˜¾ç¤º epoch å†…çš„ step è¿›åº¦ (x/steps_per_epoch)

**è¿›åº¦æ±‡æ€»è¾“å‡º**:
```
====================================================================================================
ğŸ“ˆ è®­ç»ƒè¿›åº¦æ±‡æ€» [Epoch 0 | Step 100]
====================================================================================================
  Step è¿›åº¦: 100/100000 (0.10%)
  Epoch è¿›åº¦: 0.2 / 2631.58 epochs
  å·²å¤„ç†æ ·æœ¬æ¬¡æ•°: 400
  å·²ç”¨æ—¶é—´: 0.05 å°æ—¶
  è®­ç»ƒé€Ÿåº¦: 2000.00 steps/å°æ—¶
  é¢„è®¡å‰©ä½™: 49.95 å°æ—¶
  å¹³å‡æ•°æ®åŠ è½½: 0.123ç§’/step
  å¹³å‡è®­ç»ƒæ—¶é—´: 1.111ç§’/step
  æ•°æ®åŠ è½½å æ¯”: 10.0%
====================================================================================================
```

### 2. è®­ç»ƒå™¨å®ç°ç±»ä¿®æ”¹ (`trellis/trainers/basic.py`)

#### Checkpoint ä¿å­˜/åŠ è½½ï¼š

- **ä¿å­˜**: åœ¨ `misc_ckpt` ä¸­æ·»åŠ äº† `epoch` å­—æ®µ
- **åŠ è½½**: ä» checkpoint åŠ è½½ `epoch`ï¼Œå¦‚æœæ—§ç‰ˆæœ¬ checkpoint ä¸åŒ…å«åˆ™æ ¹æ® step è®¡ç®—

### 3. é…ç½®æ–‡ä»¶æ›´æ–°

å·²æ›´æ–°æ‰€æœ‰é…ç½®æ–‡ä»¶ï¼Œåœ¨ `max_steps` åæ·»åŠ äº† `max_epoch` å‚æ•°ï¼š

**VAE é…ç½®** (`configs/vae/`):
- `ct_vqvae_stage1.json`
- `ct_vqvae_stage2.json`
- `sparse_sdf_vqvae_64.json`
- `sparse_sdf_vqvae_512.json`
- `sparse_sdf_vqvae_1024.json`
- `slat_vae_dec_rf_swin8_B_64l8_fp16.json`
- `slat_vae_enc_dec_gs_swin8_B_64l8_fp16.json`
- `slat_vae_dec_mesh_swin8_B_64l8_fp16.json`
- `ss_vae_conv3d_16l8_fp16.json`

**Generation é…ç½®** (`configs/generation/`):
- `slat_flow_txt_dit_B_64l8p2_fp16.json`
- `slat_flow_txt_dit_L_64l8p2_fp16.json`
- `slat_flow_txt_dit_XL_64l8p2_fp16.json`
- `slat_flow_img_dit_L_64l8p2_fp16.json`
- `ss_flow_txt_dit_B_16l8_fp16.json`
- `ss_flow_txt_dit_L_16l8_fp16.json`
- `ss_flow_txt_dit_XL_16l8_fp16.json`
- `ss_flow_img_dit_L_16l8_fp16.json`

## ä½¿ç”¨æ–¹æ³•

### æ–¹å¼ 1: ä»…ä½¿ç”¨ max_stepsï¼ˆåŸæœ‰æ–¹å¼ï¼Œæ— å˜åŒ–ï¼‰

```json
{
    "trainer": {
        "args": {
            "max_steps": 100000,
            "max_epoch": null,
            ...
        }
    }
}
```

è®­ç»ƒå°†åœ¨è¾¾åˆ° 100000 æ­¥æ—¶åœæ­¢ã€‚

### æ–¹å¼ 2: ä»…ä½¿ç”¨ max_epoch

```json
{
    "trainer": {
        "args": {
            "max_steps": null,
            "max_epoch": 100,
            ...
        }
    }
}
```

è®­ç»ƒå°†åœ¨å®Œæˆ 100 ä¸ª epoch æ—¶åœæ­¢ã€‚

### æ–¹å¼ 3: åŒæ—¶ä½¿ç”¨ max_steps å’Œ max_epoch

```json
{
    "trainer": {
        "args": {
            "max_steps": 100000,
            "max_epoch": 50,
            ...
        }
    }
}
```

è®­ç»ƒå°†åœ¨è¾¾åˆ° 100000 æ­¥**æˆ–** 50 ä¸ª epoch æ—¶åœæ­¢ï¼ˆä»¥å…ˆåˆ°ä¸ºå‡†ï¼‰ã€‚

## ç¤ºä¾‹åœºæ™¯

å‡è®¾æ•°æ®é›†æœ‰ 150 ä¸ªæ ·æœ¬ï¼Œ`batch_size_per_gpu=2`ï¼Œä½¿ç”¨ 2 ä¸ª GPUï¼š

- æ€» batch size = 2 Ã— 2 = 4
- æ¯ä¸ª epoch çš„æ­¥æ•° = âŒˆ150 / 4âŒ‰ = 38 steps

**åœºæ™¯ 1**: `max_steps=100000, max_epoch=null`
- è®­ç»ƒ 100000 æ­¥ â‰ˆ 2631.58 ä¸ª epoch

**åœºæ™¯ 2**: `max_steps=null, max_epoch=100`
- è®­ç»ƒ 100 ä¸ª epoch = 3800 æ­¥

**åœºæ™¯ 3**: `max_steps=1000, max_epoch=100`
- è®­ç»ƒå°†åœ¨ 1000 æ­¥æ—¶åœæ­¢ï¼ˆ26.3 ä¸ª epochï¼‰
- å› ä¸º 1000 æ­¥ < 3800 æ­¥ï¼ˆ100 epochï¼‰

## å‘åå…¼å®¹æ€§

- âœ… å®Œå…¨å‘åå…¼å®¹ï¼šå¦‚æœ `max_epoch=null`ï¼Œè¡Œä¸ºä¸ä¹‹å‰å®Œå…¨ä¸€è‡´
- âœ… æ—§çš„ checkpoint å¯ä»¥æ­£å¸¸åŠ è½½ï¼Œä¼šè‡ªåŠ¨è®¡ç®— epoch
- âœ… æ–°çš„ checkpoint åŒ…å« epoch ä¿¡æ¯ï¼Œå¯ä»¥ç²¾ç¡®æ¢å¤è®­ç»ƒçŠ¶æ€

## æ³¨æ„äº‹é¡¹

1. `max_steps` å’Œ `max_epoch` ä¸èƒ½åŒæ—¶ä¸º `null`
2. Epoch è®¡æ•°ä» 0 å¼€å§‹
3. æ•°æ®ä¼šè‡ªåŠ¨å¾ªç¯ï¼Œä¸å—æ•°æ®é›†å¤§å°é™åˆ¶
4. æ–­ç‚¹ç»­è®­æ—¶ï¼Œepoch ä¿¡æ¯ä¹Ÿä¼šè¢«ä¿å­˜å’Œæ¢å¤

