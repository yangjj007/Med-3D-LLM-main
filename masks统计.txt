                  ==========================================                                                                                                           09:29:06 [113/234]
病例: PANCREAS_0004                                                                                                                                                                      
路径: M3D_Seg/0008/0008/PANCREAS_0004                                                                                                                                                    
                  ==========================================                                                                                                           09:29:06 [110/234]
                                                                                                                                                                       09:29:06 [109/234]
1. 检查 image.npy                                                                                                                                                                        
  ✓ 加载成功                                                                                                                                                                             
  形状: (1, 512, 512, 221)                                                                                                                                                               
  数据类型: float32                                                                                                                                                                      
  值范围: [-3.38, 8.47]                                                                                                                                                                  
  文件大小: 221.00 MB                                                                                                                                                                    
                                                                                                                                                                       09:29:06 [102/234]
2. 检查 mask 文件                                                                                                                                                                        
                                                                                                                                                                       09:29:06 [100/234]
  文件: mask_(1, 512, 512, 221).npz                                                                                                                                                      
    文件名中的形状: (1, 512, 512, 221)                                                                                                                                                   
    ✓ 加载成功                                                                                                                                                                           
    稀疏矩阵形状: (1, 57933824)                                                                                                                                                          
    非零元素数: 63116                                                                                                                                                                    
    稀疏度: 99.89%                                                                                                                                                                       
    文件大小: 0.10 MB                                                                                                                                                                    
    ✓ 成功重塑为: (1, 512, 512, 221)                                                                                                                                                     
    唯一标签值: [0 1]                                                                                                                                                                    
    >>> 掩码类型: 单通道二值掩码（4D）                                                                                                                                                   
    >>> 说明: 形状为(1,H,W,D)的二值掩码，第一维度可squeeze                                                                                                                               
    ⚠ 警告: 建议squeeze掉第一维度                                                                                                                                                        
    >>> 预处理兼容性: ✓ 兼容（会自动squeeze）                                                                                                                                            
    标签 1: 63116 个体素 (0.11%)      


============================================================
病例: case_01
路径: M3D_Seg/0001/0001/case_01
============================================================

1. 检查 image.npy
  ✓ 加载成功
  形状: (1, 1024, 1024, 202)
  数据类型: float64
  值范围: [-1.75, 4.24]
  文件大小: 1616.00 MB

2. 检查 mask 文件

  文件: mask_(30, 1024, 1024, 202).npz
    文件名中的形状: (30, 1024, 1024, 202)
    ✓ 加载成功
    稀疏矩阵形状: (30, 211812352)
    非零元素数: 669329
    稀疏度: 99.99%
    文件大小: 0.98 MB
    ✓ 成功重塑为: (30, 1024, 1024, 202)
    唯一标签值: [False  True]
    >>> 掩码类型: 多通道布尔掩码
    >>> 说明: 30个通道，每个通道是一个布尔掩码（一个器官）
    ⚠ 警告: 需要转换为单通道标签格式才能处理
    >>> 预处理兼容性: ✓ 兼容（修复后，会自动转换）
    标签 True: 669329 个体素 (0.01%)

[2/42]

============================================================

具体风险

注意：不要对过大数组进行unique操作，太耗时

### 单/多通道数据处理逻辑

#### CT图像处理
```python
if ct_array.ndim == 4:
    if ct_array.shape[0] == 1:
        ct_array = ct_array[0]  # 安全squeeze
    else:
        print(f"警告: CT有多个通道 {ct_array.shape}，只使用第一个通道")
        ct_array = ct_array[0]  # ⚠️ 丢弃其他通道
```
- **风险**：会丢失除第一通道外的所有数据。代码虽有警告但未提供保留多通道的选项。

#### 分割掩码处理（复杂分支）
代码对4D分割数组采用启发式判断：

| 情况 | 处理方式 | 风险 |
|------|----------|------|
| **shape[0] ≤ 20 + one-hot** | `np.argmax(axis=0)` 转单通道标签 | ✅ 安全（假设无重叠） |
| **shape[0] ≤ 20 + 非one-hot** | `squeeze()` 或取`[0]` | ⚠️ 可能丢弃有效通道 |
| **shape[0] > 20 + 布尔类型** | 多通道→单通道标签转换（循环赋值） | ⚠️ **重叠区域被覆盖**（后处理器官覆盖先处理的） |
| **其他4D情况** | `squeeze()` 或取`[0]` | ⚠️ 可能错误降维 |

这里不应该用20做分界线，而且不应该存在分界线。不管多少维度，都要处理。不用考虑其他4D情况，只考虑上面2种即可。

**关键风险点**：多通道布尔掩码转换时：
```python
label_array = np.zeros(seg_array.shape[1:], dtype=np.uint8)
for i in range(num_channels):
    label_array[seg_array[i]] = i + 1  # 后续器官会覆盖重叠区域
```
若多个器官在同一体素位置重叠（如肝脏与肿瘤），**后处理的器官会覆盖先处理的**，导致部分标注丢失。

#### SDF计算中的维度处理
```python
if organ_binary.ndim == 4:
    # ... 
    else:
        organ_binary = organ_binary[0]  # ⚠️ 无条件取第一通道
```
此处对4D二值掩码直接取`[0]`，若掩码确实包含多通道信息会丢失数据（但实践中二值掩码通常为3D）。

---

### 数据丢失总结

| 场景 | 是否丢失数据 | 说明 |
|------|--------------|------|
| **CT多通道（>1）** | ✅ 是 | 明确丢弃除第一通道外的数据（有警告） |
| **分割掩码重叠** | ⚠️ 可能 | 多通道布尔掩码转换时重叠区域被覆盖 |
| **非one-hot 4D分割** | ⚠️ 可能 | 启发式判断可能错误，导致`squeeze`/取`[0]` |
| **分辨率适配** | ❌ 否 | 使用重采样（非切片丢弃） |
| **掩码模式提取器官** | ❌ 否 | `seg_adapted == label` 仅提取不修改原数据 |
| **one-hot转标签** | ❌ 否 | `argmax` 保留类别信息（假设无重叠） |

关于如何解决重叠区域被覆盖，建议放弃把所有通道的one hot编码放入一个通道的多标签编码，保持原有多通道结构。