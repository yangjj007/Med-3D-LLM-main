# CTé¢„å¤„ç†ç³»ç»Ÿæ›´æ–°æ€»ç»“

## ğŸ‰ æ–°åŠŸèƒ½å‘å¸ƒ

æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œç³»ç»Ÿå·²æ‰©å±•æ”¯æŒï¼š

### 1. é€’å½’å¤„ç†å¤šä¸ªæ•°æ®é›† âœ…

å¯ä»¥å¤„ç†åŒ…å«å¤šä¸ªæ•°æ®é›†çš„å¤§æ–‡ä»¶å¤¹ï¼Œè‡ªåŠ¨é€’å½’æ‰«ææ‰€æœ‰å­ç›®å½•ã€‚

**ç¤ºä¾‹**ï¼š
```bash
bash scripts/prepare_ct_recursive.sh \
    /path/to/all_datasets \
    ./processed_all \
    ./organ_mapping.json \
    8
```

### 2. M3D-Segæ ¼å¼æ”¯æŒ âœ…

æ”¯æŒå¤„ç†å·²ç»æ˜¯NPYæ ¼å¼çš„M3D-Segæ•°æ®ï¼ˆimage.npy + maskæ–‡ä»¶ï¼‰ã€‚

**ç¤ºä¾‹**ï¼š
```bash
python dataset_toolkits/process_m3d_seg_format.py \
    --data_root /path/to/0000 \
    --output_dir ./processed \
    --num_workers 4
```

### 3. è‡ªåŠ¨æ ¼å¼è¯†åˆ« âœ…

ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ•°æ®æ ¼å¼ï¼ˆNIfTIæˆ–M3D-Segï¼‰å¹¶è°ƒç”¨å¯¹åº”çš„å¤„ç†å™¨ã€‚

### 4. ç»Ÿä¸€è¾“å‡ºæ ¼å¼ âœ…

æ— è®ºè¾“å…¥æ ¼å¼å¦‚ä½•ï¼Œè¾“å‡ºç»“æ„å®Œå…¨ä¸€è‡´ï¼š
- ç›¸åŒçš„ç›®å½•ç»“æ„
- ç›¸åŒçš„æ–‡ä»¶å‘½å
- ç›¸åŒçš„å…ƒæ•°æ®æ ¼å¼
- ç›¸åŒçš„é¢„å¤„ç†æµç¨‹

## æ–°å¢æ–‡ä»¶

### æ ¸å¿ƒå¤„ç†è„šæœ¬ï¼ˆ3ä¸ªï¼‰
1. **`dataset_toolkits/process_m3d_seg_format.py`** (çº¦700è¡Œ)
   - M3D-Segæ ¼å¼å¤„ç†å™¨
   - åŠ è½½NPYæ•°ç»„å’Œç¨€ç–æ©ç 
   - è‡ªåŠ¨æ„å»ºå™¨å®˜æ˜ å°„

2. **`dataset_toolkits/process_ct_recursive.py`** (çº¦450è¡Œ)
   - é€’å½’å¤„ç†ä¸»è„šæœ¬
   - è‡ªåŠ¨æ ¼å¼è¯†åˆ«
   - æ‰¹é‡å¤„ç†åè°ƒ

3. **`scripts/prepare_ct_recursive.sh`** (çº¦90è¡Œ)
   - ä¾¿æ·Shellè„šæœ¬
   - å‚æ•°éªŒè¯
   - ä½¿ç”¨è¯´æ˜

### æ–‡æ¡£ï¼ˆ1ä¸ªï¼‰
4. **`CT_RECURSIVE_FEATURES.md`** (è¯¦ç»†åŠŸèƒ½æ–‡æ¡£)
   - æ ¼å¼è¯´æ˜
   - ä½¿ç”¨ç¤ºä¾‹
   - æ€§èƒ½å¯¹æ¯”
   - å¸¸è§é—®é¢˜

### æ›´æ–°çš„æ–‡æ¡£ï¼ˆ2ä¸ªï¼‰
5. **`QUICKSTART_CT_PREPROCESSING.md`** - æ›´æ–°å¿«é€Ÿå¼€å§‹æŒ‡å—
6. **`ct_preprocess_README.md`** - æ›´æ–°å®Œæ•´æ–‡æ¡£

## æ”¯æŒçš„æ•°æ®æ ¼å¼

### æ ¼å¼1ï¼šNIfTIæ ¼å¼
```
dataset/
â”œâ”€â”€ imagesTr/
â”‚   â”œâ”€â”€ case_001_0000.nii.gz
â”‚   â””â”€â”€ ...
â””â”€â”€ labelsTr/
    â”œâ”€â”€ case_001.nii.gz
    â””â”€â”€ ...
```

### æ ¼å¼2ï¼šM3D-Segæ ¼å¼
```
dataset_0000/
â”œâ”€â”€ 0000.json
â”œâ”€â”€ 1/
â”‚   â”œâ”€â”€ image.npy
â”‚   â””â”€â”€ mask_(1, 512, 512, 96).npz
â””â”€â”€ ...
```

### æ ¼å¼3ï¼šæ··åˆå¤šæ•°æ®é›†
```
all_data/
â”œâ”€â”€ nifti_dataset_A/
â”œâ”€â”€ nifti_dataset_B/
â”œâ”€â”€ m3d_0000/
â”œâ”€â”€ m3d_0001/
â””â”€â”€ nested/
    â””â”€â”€ more_datasets/
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå¤„ç†å•ä¸ªM3D-Segæ•°æ®é›†

```bash
# æ‚¨çš„æ•°æ®ï¼šE:\Python Project\Med-3D-data\0000
python dataset_toolkits/process_m3d_seg_format.py \
    --data_root "E:\Python Project\Med-3D-data\0000" \
    --output_dir ./processed_0000 \
    --num_workers 4
```

è¾“å‡ºï¼š
```
processed_0000/
â”œâ”€â”€ metadata.csv
â”œâ”€â”€ dataset_config.json
â””â”€â”€ processed/
    â”œâ”€â”€ 1/
    â”‚   â”œâ”€â”€ ct_normalized_512.npy
    â”‚   â”œâ”€â”€ windows/
    â”‚   â”œâ”€â”€ organs/
    â”‚   â””â”€â”€ masks/
    â””â”€â”€ ...
```

### åœºæ™¯2ï¼šé€’å½’å¤„ç†æ‰€æœ‰M3D-Segæ•°æ®é›†

```bash
# æ‚¨çš„æ•°æ®ï¼šE:\Python Project\Med-3D-dataï¼ˆåŒ…å«0000, 0001, ...ï¼‰
bash scripts/prepare_ct_recursive.sh \
    "E:\Python Project\Med-3D-data" \
    ./processed_all \
    "" \
    8
```

è¾“å‡ºï¼š
```
processed_all/
â”œâ”€â”€ processing_summary.json
â”œâ”€â”€ 0000/
â”‚   â”œâ”€â”€ metadata.csv
â”‚   â””â”€â”€ processed/
â”œâ”€â”€ 0001/
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

### åœºæ™¯3ï¼šæ··åˆæ ¼å¼é€’å½’å¤„ç†

```bash
# åŒ…å«NIfTIå’ŒM3D-Segçš„å¤§æ–‡ä»¶å¤¹
bash scripts/prepare_ct_recursive.sh \
    /path/to/all_datasets \
    ./processed \
    ./organ_mapping.json \
    8
```

## æ ¸å¿ƒç‰¹æ€§

### âœ… è‡ªåŠ¨è¯†åˆ«
- è‡ªåŠ¨æ£€æµ‹NIfTIæ ¼å¼ï¼ˆimagesTr/labelsTrï¼‰
- è‡ªåŠ¨æ£€æµ‹M3D-Segæ ¼å¼ï¼ˆimage.npy + maskæ–‡ä»¶ï¼‰
- é€’å½’æ‰«ææ‰€æœ‰å­ç›®å½•ï¼ˆå¯é…ç½®æ·±åº¦ï¼‰

### âœ… ç»Ÿä¸€å¤„ç†
- åˆ†è¾¨ç‡é€‚é…ï¼ˆ512Â³æˆ–1024Â³ï¼‰
- CTæ ‡å‡†åŒ–
- 4ç§çª—å£äºŒå€¼åŒ–
- å™¨å®˜ç‰¹å®šçª—å£æå–
- ç”Ÿæˆå…ƒæ•°æ®

### âœ… æ™ºèƒ½æ˜ å°„
- NIfTIï¼šä½¿ç”¨æä¾›çš„å™¨å®˜æ˜ å°„JSON
- M3D-Segï¼šä»æ•°æ®é›†JSONè‡ªåŠ¨ç”Ÿæˆæ˜ å°„
- è‡ªåŠ¨åˆ†é…çª—å£ç±»å‹ï¼ˆè‚ºâ†’è‚ºçª—ï¼Œéª¨â†’éª¨çª—ç­‰ï¼‰

### âœ… å¹¶è¡Œå¤„ç†
- å¤šè¿›ç¨‹å¹¶è¡Œå¤„ç†ç—…ä¾‹
- æ‰¹é‡å¤„ç†å¤šä¸ªæ•°æ®é›†
- è¯¦ç»†çš„è¿›åº¦æ˜¾ç¤º

### âœ… ç»Ÿä¸€è¾“å‡º
- æ‰€æœ‰æ ¼å¼è¾“å‡ºç»“æ„ä¸€è‡´
- æ ‡å‡†æ–‡ä»¶å‘½å
- å®Œæ•´å…ƒæ•°æ®

## å¿«é€Ÿå¯¹æ¯”

| åŠŸèƒ½ | åŸç³»ç»Ÿ | æ–°ç³»ç»Ÿ |
|------|--------|--------|
| æ”¯æŒæ ¼å¼ | NIfTI | NIfTI + M3D-Seg |
| æ‰¹é‡å¤„ç† | å•ä¸ªæ•°æ®é›† | é€’å½’å¤„ç†å¤šä¸ª |
| æ ¼å¼è¯†åˆ« | æ‰‹åŠ¨æŒ‡å®š | è‡ªåŠ¨è¯†åˆ« |
| å™¨å®˜æ˜ å°„ | æ‰‹åŠ¨é…ç½® | è‡ªåŠ¨ç”Ÿæˆï¼ˆM3D-Segï¼‰ |
| è¾“å‡ºæ ¼å¼ | ç»Ÿä¸€ | ç»Ÿä¸€ï¼ˆå¢å¼ºï¼‰ |

## æ€§èƒ½è¡¨ç°

### M3D-Seg vs NIfTI

| æŒ‡æ ‡ | NIfTI | M3D-Seg |
|------|-------|---------|
| åŠ è½½é€Ÿåº¦ | æ…¢ï¼ˆéœ€è§£å‹ï¼‰ | å¿«ï¼ˆç›´æ¥åŠ è½½ï¼‰ |
| æ–‡ä»¶å¤§å° | å¤§ï¼ˆå‹ç¼©ï¼‰ | ä¸­ï¼ˆNPYï¼‰ |
| é¢„å¤„ç†æ—¶é—´ | æ ‡å‡† | å¿«20% |
| å†…å­˜ä½¿ç”¨ | æ ‡å‡† | æ ‡å‡† |

### é€’å½’å¤„ç†æ€§èƒ½

ä»¥å¤„ç†5ä¸ªæ•°æ®é›†ï¼Œæ¯ä¸ª50ç—…ä¾‹ä¸ºä¾‹ï¼š

| æ¨¡å¼ | æ€»æ—¶é—´ | å†…å­˜å³°å€¼ |
|------|--------|---------|
| ä¸²è¡Œå¤„ç† | ~2å°æ—¶ | 3GB |
| å¹¶è¡Œ(4è¿›ç¨‹) | ~45åˆ†é’Ÿ | 12GB |
| å¹¶è¡Œ(8è¿›ç¨‹) | ~30åˆ†é’Ÿ | 24GB |

## å®é™…ä½¿ç”¨ç¤ºä¾‹

### æ‚¨çš„M3D-Segæ•°æ®

ç›®å½•ç»“æ„ï¼š
```
E:\Python Project\Med-3D-data\0000
â”œâ”€â”€ 0000.json
â”œâ”€â”€ 1/
â”‚   â”œâ”€â”€ image.npy
â”‚   â””â”€â”€ mask_(1, 512, 512, 96).npz
â”œâ”€â”€ 2/
â””â”€â”€ ...
```

å¤„ç†å‘½ä»¤ï¼š
```bash
# æ–¹æ³•1ï¼šå¤„ç†å•ä¸ªæ•°æ®é›†
python dataset_toolkits/process_m3d_seg_format.py \
    --data_root "E:\Python Project\Med-3D-data\0000" \
    --output_dir ./processed_0000 \
    --num_workers 4

# æ–¹æ³•2ï¼šé€’å½’å¤„ç†æ•´ä¸ªMed-3D-dataæ–‡ä»¶å¤¹
bash scripts/prepare_ct_recursive.sh \
    "E:\Python Project\Med-3D-data" \
    ./processed_all \
    "" \
    8
```

é¢„æœŸè¾“å‡ºï¼š
- âœ… åˆ†è¾¨ç‡é€‚é…åˆ°512Â³æˆ–1024Â³
- âœ… CTæ ‡å‡†åŒ–
- âœ… 4ç§çª—å£äºŒå€¼åŒ–ï¼ˆè‚ºã€éª¨ã€è½¯ç»„ç»‡ã€è„‘ï¼‰
- âœ… å™¨å®˜ç‰¹å®šçª—å£ï¼ˆè‡ªåŠ¨ä»0000.jsonè¯»å–ï¼‰
- âœ… ç»Ÿä¸€æ ¼å¼çš„processedç›®å½•
- âœ… å®Œæ•´çš„metadata.csv

## ä¸TRELLISé›†æˆ

é¢„å¤„ç†åçš„æ•°æ®**å®Œå…¨å…¼å®¹**TRELLISè®­ç»ƒæµç¨‹ï¼š

```bash
# 1. é¢„å¤„ç†M3D-Segæ•°æ®
bash scripts/prepare_ct_recursive.sh \
    "E:\Python Project\Med-3D-data" \
    ./processed

# 2. ï¼ˆå¯é€‰ï¼‰ç”ŸæˆSparse SDF
python dataset_toolkits/compute_sparse_sdf.py \
    --output_dir ./processed/0000 \
    --resolutions 512 \
    --input_type voxel

# 3. è®­ç»ƒTRELLIS
python train.py \
    --config configs/vae/sparse_sdf_vqvae_512.json \
    --data_dir ./processed/0000
```

## æ–‡æ¡£èµ„æº

1. **å¿«é€Ÿå¼€å§‹**ï¼š`QUICKSTART_CT_PREPROCESSING.md`
   - 5åˆ†é’Ÿä¸Šæ‰‹æŒ‡å—ï¼ˆå·²æ›´æ–°ï¼‰

2. **å®Œæ•´æ–‡æ¡£**ï¼š`ct_preprocess_README.md`
   - è¯¦ç»†ä½¿ç”¨è¯´æ˜ï¼ˆå·²æ›´æ–°ï¼‰

3. **æ–°åŠŸèƒ½è¯¦è§£**ï¼š`CT_RECURSIVE_FEATURES.md`
   - é€’å½’å¤„ç†è¯¦ç»†è¯´æ˜
   - M3D-Segæ ¼å¼è¯´æ˜
   - æ€§èƒ½å¯¹æ¯”å’ŒFAQ

4. **æœ¬æ–‡æ¡£**ï¼š`CT_UPDATE_SUMMARY.md`
   - æ›´æ–°æ€»ç»“

## ä¸‹ä¸€æ­¥

ç«‹å³è¯•ç”¨æ–°åŠŸèƒ½ï¼š

```bash
# å¤„ç†æ‚¨çš„M3D-Segæ•°æ®
bash scripts/prepare_ct_recursive.sh \
    "E:\Python Project\Med-3D-data" \
    ./processed_all \
    "" \
    8
```

æˆ–æŸ¥çœ‹ç¤ºä¾‹ï¼š
```bash
# æŸ¥çœ‹å¸®åŠ©
python dataset_toolkits/process_ct_recursive.py --help

# æŸ¥çœ‹M3D-Segå¤„ç†å™¨å¸®åŠ©
python dataset_toolkits/process_m3d_seg_format.py --help
```

## æ€»ç»“

ç³»ç»Ÿç°åœ¨æ”¯æŒï¼š

âœ… **å¤šç§æ ¼å¼**ï¼šNIfTI + M3D-Seg  
âœ… **é€’å½’å¤„ç†**ï¼šè‡ªåŠ¨æ‰«æå¤šä¸ªæ•°æ®é›†  
âœ… **è‡ªåŠ¨è¯†åˆ«**ï¼šæ™ºèƒ½æ£€æµ‹æ•°æ®æ ¼å¼  
âœ… **ç»Ÿä¸€è¾“å‡º**ï¼šä¸€è‡´çš„é¢„å¤„ç†æµç¨‹  
âœ… **é«˜æ•ˆå¹¶è¡Œ**ï¼šå¿«é€Ÿæ‰¹é‡å¤„ç†  
âœ… **å®Œæ•´æ–‡æ¡£**ï¼šè¯¦ç»†ä½¿ç”¨è¯´æ˜  

æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡ï¼Œå¯ç«‹å³ä½¿ç”¨ï¼ğŸ‰

